#!/usr/bin/env bash
# AI Context Extraction Script
# Generates useful context about the current project for AI assistants

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get current directory
CWD="$(pwd)"
PROJECT_NAME="$(basename "$CWD")"

echo -e "${BLUE}=== AI Context for: ${PROJECT_NAME} ===${NC}\n"

# 1. Project Information
echo -e "${GREEN}## Project Information${NC}"
echo "Directory: $CWD"
echo "Date: $(date '+%Y-%m-%d %H:%M:%S')"
echo ""

# 2. Git Information
if git rev-parse --git-dir > /dev/null 2>&1; then
  echo -e "${GREEN}## Git Status${NC}"
  echo "Branch: $(git branch --show-current)"
  echo "Remote: $(git remote get-url origin 2>/dev/null || echo 'No remote')"
  echo ""

  echo -e "${YELLOW}Recent Commits (last 10):${NC}"
  git log --oneline --graph -10
  echo ""

  echo -e "${YELLOW}Current Changes:${NC}"
  git status --short
  echo ""

  # Uncommitted changes
  if ! git diff --quiet; then
    echo -e "${YELLOW}Unstaged Diff Summary:${NC}"
    git diff --stat
    echo ""
  fi

  if ! git diff --cached --quiet; then
    echo -e "${YELLOW}Staged Diff Summary:${NC}"
    git diff --cached --stat
    echo ""
  fi
else
  echo -e "${YELLOW}Not a git repository${NC}\n"
fi

# 3. Project Structure
echo -e "${GREEN}## Project Structure${NC}"
if command -v eza &>/dev/null; then
  eza --tree --level=2 --icons --git-ignore -I 'node_modules|.git|.venv|__pycache__|dist|build|.next|.cache'
elif command -v tree &>/dev/null; then
  tree -L 2 -a -I 'node_modules|.git|.venv|__pycache__|dist|build|.next|.cache'
else
  find . -maxdepth 2 -not -path '*/\.*' -not -path '*/node_modules/*'
fi
echo ""

# 4. Package/Dependency Information
echo -e "${GREEN}## Dependencies & Tools${NC}"

# Node.js
if [[ -f "package.json" ]]; then
  echo -e "${YELLOW}Node.js Project:${NC}"
  echo "  Node Version: $(node --version 2>/dev/null || echo 'not installed')"
  echo "  Package Manager: $(if [[ -f "bun.lockb" ]]; then echo "bun"; elif [[ -f "pnpm-lock.yaml" ]]; then echo "pnpm"; elif [[ -f "yarn.lock" ]]; then echo "yarn"; else echo "npm"; fi)"
  if command -v jq &>/dev/null && [[ -f "package.json" ]]; then
    echo "  Scripts available:"
    jq -r '.scripts | to_entries | .[] | "    - \(.key): \(.value)"' package.json 2>/dev/null || echo "    (unable to parse scripts)"
  fi
  echo ""
fi

# Python
if [[ -f "pyproject.toml" ]] || [[ -f "requirements.txt" ]] || [[ -f "setup.py" ]]; then
  echo -e "${YELLOW}Python Project:${NC}"
  echo "  Python Version: $(python --version 2>/dev/null || python3 --version 2>/dev/null || echo 'not installed')"
  [[ -f "pyproject.toml" ]] && echo "  Config: pyproject.toml"
  [[ -f "requirements.txt" ]] && echo "  Dependencies: requirements.txt ($(wc -l < requirements.txt) packages)"
  [[ -f ".venv/bin/activate" ]] && echo "  Virtual Env: .venv/"
  echo ""
fi

# Go
if [[ -f "go.mod" ]]; then
  echo -e "${YELLOW}Go Project:${NC}"
  echo "  Go Version: $(go version 2>/dev/null || echo 'not installed')"
  echo "  Module: $(head -1 go.mod)"
  echo ""
fi

# Rust
if [[ -f "Cargo.toml" ]]; then
  echo -e "${YELLOW}Rust Project:${NC}"
  echo "  Rust Version: $(rustc --version 2>/dev/null || echo 'not installed')"
  if command -v cargo &>/dev/null; then
    echo "  Package: $(cargo metadata --no-deps --format-version 1 2>/dev/null | jq -r '.packages[0].name' || echo 'unknown')"
  fi
  echo ""
fi

# Docker
if [[ -f "Dockerfile" ]] || [[ -f "docker-compose.yml" ]] || [[ -f "docker-compose.yaml" ]]; then
  echo -e "${YELLOW}Docker:${NC}"
  [[ -f "Dockerfile" ]] && echo "  - Dockerfile present"
  [[ -f "docker-compose.yml" ]] || [[ -f "docker-compose.yaml" ]] && echo "  - docker-compose present"
  echo ""
fi

# Mise/tool versions
if [[ -f ".mise.toml" ]] || [[ -f ".tool-versions" ]]; then
  echo -e "${YELLOW}Tool Versions (mise):${NC}"
  if command -v mise &>/dev/null; then
    mise current 2>/dev/null || echo "  (error reading mise versions)"
  else
    cat ".mise.toml" 2>/dev/null || cat ".tool-versions" 2>/dev/null || echo "  (unable to read versions)"
  fi
  echo ""
fi

# 5. TODOs and FIXMEs
echo -e "${GREEN}## TODOs & FIXMEs${NC}"
if command -v rg &>/dev/null; then
  rg --no-heading --line-number 'TODO|FIXME|XXX|HACK|NOTE' \
    --glob '!node_modules' --glob '!.git' --glob '!dist' --glob '!build' \
    --max-count 20 2>/dev/null || echo "  No TODOs found"
else
  grep -r -n -E 'TODO|FIXME|XXX|HACK|NOTE' . \
    --exclude-dir={node_modules,.git,dist,build,.next,.cache} \
    2>/dev/null | head -20 || echo "  No TODOs found"
fi
echo ""

# 6. Recent Files
echo -e "${GREEN}## Recently Modified Files (last 24 hours)${NC}"
if command -v fd &>/dev/null; then
  fd --changed-within 1d --type f \
    --exclude node_modules --exclude .git --exclude dist --exclude build \
    --exec-batch ls -lht | head -15
else
  find . -type f -mtime -1 \
    -not -path "*/node_modules/*" -not -path "*/.git/*" \
    -not -path "*/dist/*" -not -path "*/build/*" \
    -exec ls -lht {} + 2>/dev/null | head -15
fi
echo ""

# 7. Errors in logs (if any)
if [[ -d "logs" ]] || ls *.log &>/dev/null 2>&1; then
  echo -e "${GREEN}## Recent Errors in Logs${NC}"
  if command -v rg &>/dev/null; then
    rg -i 'error|exception|fatal|critical' logs/ *.log 2>/dev/null | head -10 || echo "  No errors found"
  else
    grep -i -r 'error\|exception\|fatal\|critical' logs/ *.log 2>/dev/null | head -10 || echo "  No errors found"
  fi
  echo ""
fi

# 8. Open Ports (development servers)
echo -e "${GREEN}## Active Development Servers${NC}"
if command -v lsof &>/dev/null; then
  echo "Listening on common dev ports:"
  lsof -iTCP -sTCP:LISTEN -n -P 2>/dev/null | grep -E ':(3000|3001|4000|5000|5173|8000|8080|8888|9000)' || echo "  No dev servers running"
else
  echo "  (lsof not available)"
fi
echo ""

# 9. Environment Info
echo -e "${GREEN}## Environment${NC}"
echo "Shell: $SHELL"
echo "OS: $(uname -s) $(uname -r)"
echo "PWD: $PWD"
[[ -n "${VIRTUAL_ENV:-}" ]] && echo "Python venv: $VIRTUAL_ENV"
[[ -n "${NODE_ENV:-}" ]] && echo "NODE_ENV: $NODE_ENV"
echo ""

echo -e "${BLUE}=== End of Context ===${NC}"
