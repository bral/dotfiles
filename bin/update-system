#!/usr/bin/env zsh
# Updates development tools and system packages
# Enhanced version with parallel updates and better error handling
set -euo pipefail

# Simple colored output
info() { echo -e "\033[0;34mℹ\033[0m $1" }
ok() { echo -e "\033[0;32m✓\033[0m $1" }
warn() { echo -e "\033[1;33m⚠\033[0m $1" }
error() { echo -e "\033[0;31m✗\033[0m $1" >&2 }

# Error handler
handle_error() {
    local func="$1"
    error "Failed to update $func"
    return 0  # Don't fail the whole script
}

update_brew() {
    info "Updating Homebrew"
    brew update && brew upgrade && brew cleanup
    ok "Homebrew updated"
}

update_node() {
    command -v pnpm &>/dev/null && pnpm update -g
    ok "Node tools updated"
}

update_python() {
    command -v pip &>/dev/null && pip install -U pip
    ok "Python tools updated"  
}

update_mise() {
    if command -v mise &>/dev/null; then
        mise upgrade
        mise self-update -y
        ok "mise updated"
    fi
}

update_go_tools() {
    if command -v go &>/dev/null; then
        go install github.com/danielmiessler/fabric@latest
        go install github.com/gofast-live/gofast-cli/cmd/gofast@latest
        ok "Go tools updated"
    fi
}

update_spacevim() {
    if [[ -d "$HOME/.SpaceVim" ]]; then
        (cd "$HOME/.SpaceVim" && git pull)
        command -v nvim &>/dev/null && nvim +SPUpdate +qall
        ok "SpaceVim updated"
    fi
}

update_fzf() {
    if [[ -d "$HOME/.fzf" ]]; then
        (cd "$HOME/.fzf" && git pull && ./install --all)
        ok "FZF updated"
    fi
}

check_macos() {
    info "Checking macOS updates"
    if softwareupdate -l 2>/dev/null | grep -q "No new software"; then
        ok "macOS up to date"
    else
        warn "macOS updates available"
    fi
}

cleanup() {
    info "Cleaning package caches"
    command -v npm &>/dev/null && npm cache clean --force
    command -v pnpm &>/dev/null && pnpm store prune  
    ok "Cleanup done"
}

update_vscode() {
    # DISABLED: code --install-extension opens VSCode GUI and steals focus
    # This is extremely disruptive during automated updates
    # To manually update VSCode extensions, run:
    #   code --list-extensions | xargs -L 1 code --install-extension --force
    # Or update extensions via VSCode UI: Cmd+Shift+P -> "Extensions: Check for Updates"
    info "VSCode extensions (manual update recommended)"
    warn "Run 'code --list-extensions | xargs -L 1 code --install-extension' manually"
}

update_claude() {
    info "Checking Claude Code updates"
    if command -v npm &>/dev/null; then
        npm update -g @anthropic-ai/claude-code 2>/dev/null || warn "Claude Code not installed via npm"
    fi
    ok "Claude Code checked"
}

update_starship() {
    if command -v starship &>/dev/null; then
        info "Updating Starship"
        brew upgrade starship 2>/dev/null || warn "Starship already up to date"
        ok "Starship checked"
    fi
}

full_update() {
    info "Running full system update"
    echo ""

    # Core package managers
    update_brew || handle_error "Homebrew"
    update_mise || handle_error "mise"

    # Language tools
    update_node || handle_error "Node"
    update_python || handle_error "Python"
    update_go_tools || handle_error "Go tools"

    # Editors
    update_spacevim || handle_error "SpaceVim"
    update_vscode || handle_error "VSCode"

    # Shell & CLI
    update_fzf || handle_error "FZF"
    update_starship || handle_error "Starship"

    # AI tools
    update_claude || handle_error "Claude Code"

    # Cleanup
    cleanup || handle_error "cleanup"

    echo ""
    ok "Full update complete"
}

quick_update() {
    info "Running quick update"
    update_brew
    update_mise
    ok "Quick update complete"
}

check_updates() {
    info "Checking for updates"
    echo "\nHomebrew:"
    brew outdated
    echo "\nmise:"
    command -v mise &>/dev/null && mise outdated
    echo "\npnpm:"
    command -v pnpm &>/dev/null && pnpm outdated -g
    echo "\nmacOS:"
    softwareupdate -l
}

show_help() {
    echo "Usage: $(basename $0) [full|quick|check]"
    echo "  full  - Update everything (default)"
    echo "  quick - Update brew and mise only"  
    echo "  check - Show what needs updating"
}

case "${1:-full}" in
    full|all|"") full_update ;;
    quick) quick_update ;;
    check) check_updates ;;
    help|-h|--help) show_help ;;
    *) 
        echo "Unknown command: $1" >&2
        show_help
        exit 1
        ;;
esac